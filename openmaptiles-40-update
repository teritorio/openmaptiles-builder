#!/usr/bin/bash

set -e

docker-compose run --rm build bash -e -c "
    cd /data/pbf
    /usr/lib/python3-pyosmium/pyosmium-up-to-date andorra-latest.osm.pbf
    /usr/lib/python3-pyosmium/pyosmium-up-to-date spain-latest.osm.pbf
    /usr/lib/python3-pyosmium/pyosmium-up-to-date france-latest.osm.pbf
"

docker-compose run --rm build bash -e -c "
    cd /data/pbf
    osmium merge -v --progress \
        --overwrite -o merge.osm.pbf \
        france-latest.osm.pbf \
        spain-latest.osm.pbf \
        andorra-latest.osm.pbf
"

mv pbf/merge.osm.pbf openmaptiles/data/

cd openmaptiles
docker-compose down -v && \
docker-compose up -d postgres && sleep 10 && \
docker-compose run --rm import-water && \
docker-compose run --rm import-osmborder && \
docker-compose run --rm import-natural-earth && \
docker-compose run --rm import-lakelines && \
docker-compose run --rm import-osm && \
docker-compose run --rm import-wikidata && \
docker-compose run --rm import-sql && \
docker-compose -f docker-compose.yml -f ./data/docker-compose-config.yml  run --rm generate-vectortiles
cd ..


mv openmaptiles/data/tiles.mbtiles mbtiles/openmaptiles-v3-france-z10-z14.mbtiles

# 8m39,435s
docker-compose run --rm build bash -e -c "
    cd /data/mbtiles
    tile-join --no-tile-size-limit \
        --attribution '<a href=\"https://www.teritorio.fr/\" target=\"_blank\">&copy; Teritorio</a> <a href=\"https://www.openmaptiles.org/\" target=\"_blank\">&copy; OpenMapTiles</a> <a href=\"https://www.openstreetmap.org/copyright\" target=\"_blank\">&copy; OpenStreetMap contributors</a>' \
        --force -o teritorio-dev.mbtiles \
        openmaptiles-v3-z0-z6.mbtiles \
        openmaptiles-v3-france-z7-z9.mbtiles \
        openmaptiles-v3-france-z10-z14.mbtiles
"
